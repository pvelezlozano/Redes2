<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>AOSP Preupload Hooks</title><link rel="stylesheet" type="text/css" href="/+static/base.css"/><link rel="stylesheet" type="text/css" href="/+static/doc.css"/><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.css"/><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header "><div class="Header"><div class="Header-title"></div></div></header><div class="Site-content Site-Content--markdown"><div class="Container"><div class="doc"><h1><a class="h" name="AOSP-Preupload-Hooks" href="#AOSP-Preupload-Hooks"><span></span></a><a class="h" name="aosp-preupload-hooks" href="#aosp-preupload-hooks"><span></span></a>AOSP Preupload Hooks</h1><p>This repo holds hooks that get run by repo during the upload phase.  They perform various checks automatically such as running linters on your code.</p><p>Note: Currently all hooks are disabled by default.  Each repo must explicitly turn on any hook it wishes to enforce.</p><div class="toc" role="navigation"><h2>Contents</h2><div class="toc-aux"><ul><li><a href="#AOSP-Preupload-Hooks">AOSP Preupload Hooks</a></li><ul><li><a href="#Usage">Usage</a></li><ul><li><a href="#Bypassing">Bypassing</a></li></ul></ul><li><a href="#Config-Files">Config Files</a></li><ul><li><a href="#GLOBAL_PREUPLOAD_cfg">GLOBAL-PREUPLOAD.cfg</a></li><li><a href="#PREUPLOAD_cfg">PREUPLOAD.cfg</a></li><li><a href="#Example">Example</a></li><li><a href="#Environment">Environment</a></li><li><a href="#Placeholders">Placeholders</a></li><ul><li><a href="#Examples">Examples</a></li></ul><li><a href="#Options">[Options]</a></li><li><a href="#Hook-Scripts">[Hook Scripts]</a></li><li><a href="#Builtin-Hooks">[Builtin Hooks]</a></li><li><a href="#Builtin-Hooks-Options">[Builtin Hooks Options]</a></li><li><a href="#Builtin-Hooks-Exclude-Paths">[Builtin Hooks Exclude Paths]</a></li><li><a href="#Tool-Paths">[Tool Paths]</a></li></ul><li><a href="#Hook-Developers">Hook Developers</a></li><ul><li><a href="#Warnings">Warnings</a></li></ul><li><a href="#TODO_Limitations">TODO/Limitations</a></li></ul></div></div><h2><a class="h" name="Usage" href="#Usage"><span></span></a><a class="h" name="usage" href="#usage"><span></span></a>Usage</h2><p>Normally these execute automatically when you run <code class="code">repo upload</code>.  If you want to run them by hand, you can execute <code class="code">pre-upload.py</code> directly.  By default, that will scan the active repo and process all commits that haven&#39;t yet been merged. See its help for more info.</p><h3><a class="h" name="Bypassing" href="#Bypassing"><span></span></a><a class="h" name="bypassing" href="#bypassing"><span></span></a>Bypassing</h3><p>Sometimes you might want to bypass the upload checks.  While this is <strong>strongly discouraged</strong> (often failures you add will affect others and block them too), sometimes there are valid reasons for this.  You can simply use the option <code class="code">--no-verify</code> when running <code class="code">repo upload</code> to skip all upload checks.  This will skip <strong>all</strong> checks and not just specific ones.  It should be used only after having run &amp; evaluated the upload output previously.</p><h1><a class="h" name="Config-Files" href="#Config-Files"><span></span></a><a class="h" name="config-files" href="#config-files"><span></span></a>Config Files</h1><p>There are two types of config files:</p><ul><li>Repo project-wide settings (e.g. all of AOSP).  These set up defaults for all projects that are checked out via a single manifest.</li><li>Project-local settings (e.g. a single .git repo).  These control settings for the local project you&#39;re working on.</li></ul><p>The merging of these config files control the hooks/checks that get run when running <code class="code">repo upload</code>.</p><h2><a class="h" name="GLOBAL_PREUPLOAD_cfg" href="#GLOBAL_PREUPLOAD_cfg"><span></span></a><a class="h" name="global_preupload_cfg" href="#global_preupload_cfg"><span></span></a>GLOBAL-PREUPLOAD.cfg</h2><p>These are the manifest-wide defaults and can be located in two places:</p><ul><li><code class="code">.repo/manifests/GLOBAL-PREUPLOAD.cfg</code>: The manifest git repo. Simply check this in to the manifest git repo and you&#39;re done.</li><li><code class="code">GLOBAL-PREUPLOAD.cfg</code>: The top level of the repo checkout. For manifests that don&lsquo;t have a project checked out at the top level, you can use repo&rsquo;s <code class="code">&lt;copyfile&gt;</code> directive.</li></ul><p>These config files will be loaded first before stacking <code class="code">PREUPLOAD.cfg</code> settings on top.</p><h2><a class="h" name="PREUPLOAD_cfg" href="#PREUPLOAD_cfg"><span></span></a><a class="h" name="preupload_cfg" href="#preupload_cfg"><span></span></a>PREUPLOAD.cfg</h2><p>This file is checked in the top of a specific git repository.  Stacking them in subdirectories (to try and override parent settings) is not supported.</p><h2><a class="h" name="Example" href="#Example"><span></span></a><a class="h" name="example" href="#example"><span></span></a>Example</h2><pre class="code"># Per-project `repo upload` hook settings.
# https://android.googlesource.com/platform/tools/repohooks

[Options]
ignore_merged_commits = true

[Hook Scripts]
name = script --with args ${PREUPLOAD_FILES}

[Builtin Hooks]
cpplint = true

[Builtin Hooks Options]
cpplint = --filter=-x ${PREUPLOAD_FILES}

[Tool Paths]
clang-format = /usr/bin/clang-format
</pre><h2><a class="h" name="Environment" href="#Environment"><span></span></a><a class="h" name="environment" href="#environment"><span></span></a>Environment</h2><p>Hooks are executed in the top directory of the git repository.  All paths should generally be relative to that point.</p><p>A few environment variables are set so scripts don&#39;t need to discover things.</p><ul><li><code class="code">REPO_PROJECT</code>: The name of the project. e.g. <code class="code">platform/tools/repohooks</code></li><li><code class="code">REPO_PATH</code>: The path to the project relative to the root. e.g. <code class="code">tools/repohooks</code></li><li><code class="code">REPO_REMOTE</code>: The name of the git remote. e.g. <code class="code">aosp</code>.</li><li><code class="code">REPO_LREV</code>: The name of the remote revision, translated to a local tracking branch. This is typically latest commit in the remote-tracking branch. e.g. <code class="code">ec044d3e9b608ce275f02092f86810a3ba13834e</code></li><li><code class="code">REPO_RREV</code>: The remote revision. e.g. <code class="code">master</code></li><li><code class="code">PREUPLOAD_COMMIT</code>: The commit that is currently being checked. e.g. <code class="code">1f89dce0468448fa36f632d2fc52175cd6940a91</code></li></ul><h2><a class="h" name="Placeholders" href="#Placeholders"><span></span></a><a class="h" name="placeholders" href="#placeholders"><span></span></a>Placeholders</h2><p>A few keywords are recognized to pass down settings.  These are <strong>not</strong> environment variables, but are expanded inline.  Files with whitespace and such will be expanded correctly via argument positions, so do not try to force your own quote handling.</p><ul><li><code class="code">${PREUPLOAD_FILES}</code>: List of files to operate on.</li><li><code class="code">${PREUPLOAD_FILES_PREFIXED}</code>: A list of files to operate on. Any string preceding/attached to the keyword ${PREUPLOAD_FILES_PREFIXED} will be repeated for each file automatically. If no string is preceding/attached to the keyword, the previous argument will be repeated before each file.</li><li><code class="code">${PREUPLOAD_COMMIT}</code>: Commit hash.</li><li><code class="code">${PREUPLOAD_COMMIT_MESSAGE}</code>: Commit message.</li></ul><p>Some variables are available to make it easier to handle OS differences.  These are automatically expanded for you:</p><ul><li><code class="code">${REPO_ROOT}</code>: The absolute path of the root of the repo checkout.</li><li><code class="code">${BUILD_OS}</code>: The string <code class="code">darwin-x86</code> for macOS and the string <code class="code">linux-x86</code> for Linux/x86.</li></ul><h3><a class="h" name="Examples" href="#Examples"><span></span></a><a class="h" name="examples" href="#examples"><span></span></a>Examples</h3><p>Here are some examples of using the placeholders. Consider this sample config file.</p><pre class="code">[Hook Scripts]
lister = ls ${PREUPLOAD_FILES}
checker prefix = check --file=${PREUPLOAD_FILES_PREFIXED}
checker flag = check --file ${PREUPLOAD_FILES_PREFIXED}
</pre><p>With a commit that changes <code class="code">path1/file1</code> and <code class="code">path2/file2</code>, then this will run programs with the arguments:</p><ul><li>[&lsquo;ls&rsquo;, &lsquo;path1/file1&rsquo;, &lsquo;path2/file2&rsquo;]</li><li>[&lsquo;check&rsquo;, &lsquo;--file=path1/file1&rsquo;, &lsquo;--file=path2/file2&rsquo;]</li><li>[&lsquo;check&rsquo;, &lsquo;--file&rsquo;, &lsquo;path1/file1&rsquo;, &lsquo;--file&rsquo;, &lsquo;path2/file2&rsquo;]</li></ul><h2><a class="h" name="Options" href="#Options"><span></span></a><a class="h" name="options" href="#options"><span></span></a>[Options]</h2><p>This section allows for setting options that affect the overall behavior of the pre-upload checks.  The following options are recognized:</p><ul><li><code class="code">ignore_merged_commits</code>: If set to <code class="code">true</code>, the hooks will not run on commits that are merged.  Hooks will still run on the merge commit itself.</li></ul><h2><a class="h" name="Hook-Scripts" href="#Hook-Scripts"><span></span></a><a class="h" name="hook-scripts" href="#hook-scripts"><span></span></a>[Hook Scripts]</h2><p>This section allows for completely arbitrary hooks to run on a per-repo basis.</p><p>The key can be any name (as long as the syntax is valid), as can the program that is executed. The key is used as the name of the hook for reporting purposes, so it should be at least somewhat descriptive.</p><p>Whitespace in the key name is OK!</p><p>The keys must be unique as duplicates will silently clobber earlier values.</p><p>You do not need to send stderr to stdout.  The tooling will take care of merging them together for you automatically.</p><pre class="code">[Hook Scripts]
my first hook = program --gogog ${PREUPLOAD_FILES}
another hook = funtimes --i-need &quot;some space&quot; ${PREUPLOAD_FILES}
some fish = linter --ate-a-cat ${PREUPLOAD_FILES}
some cat = formatter --cat-commit ${PREUPLOAD_COMMIT}
some dog = tool --no-cat-in-commit-message ${PREUPLOAD_COMMIT_MESSAGE}
</pre><h2><a class="h" name="Builtin-Hooks" href="#Builtin-Hooks"><span></span></a><a class="h" name="builtin-hooks" href="#builtin-hooks"><span></span></a>[Builtin Hooks]</h2><p>This section allows for turning on common/builtin hooks.  There are a bunch of canned hooks already included geared towards AOSP style guidelines.</p><ul><li><code class="code">aidl_format</code>: Run AIDL files (.aidl) through <code class="code">aidl-format</code>.</li><li><code class="code">android_test_mapping_format</code>: Validate TEST_MAPPING files in Android source code. Refer to go/test-mapping for more details.</li><li><code class="code">bpfmt</code>: Run Blueprint files (.bp) through <code class="code">bpfmt</code>.</li><li><code class="code">checkpatch</code>: Run commits through the Linux kernel&#39;s <code class="code">checkpatch.pl</code> script.</li><li><code class="code">clang_format</code>: Run git-clang-format against the commit. The default style is <code class="code">file</code>.</li><li><code class="code">commit_msg_bug_field</code>: Require a valid <code class="code">Bug:</code> line.</li><li><code class="code">commit_msg_changeid_field</code>: Require a valid <code class="code">Change-Id:</code> Gerrit line.</li><li><code class="code">commit_msg_prebuilt_apk_fields</code>: Require badging and build information for prebuilt APKs.</li><li><code class="code">commit_msg_relnote_field_format</code>: Check for possible misspellings of the <code class="code">Relnote:</code> field and that multiline release notes are properly formatted with quotes.</li><li><code class="code">commit_msg_relnote_for_current_txt</code>: Check that CLs with changes to current.txt or public_plus_experimental_current.txt also contain a <code class="code">Relnote:</code> field in the commit message.</li><li><code class="code">commit_msg_test_field</code>: Require a <code class="code">Test:</code> line.</li><li><code class="code">cpplint</code>: Run through the cpplint tool (for C++ code).</li><li><code class="code">gofmt</code>: Run Go code through <code class="code">gofmt</code>.</li><li><code class="code">google_java_format</code>: Run Java code through <a href="https://github.com/google/google-java-format"><code class="code">google-java-format</code></a></li><li><code class="code">jsonlint</code>: Verify JSON code is sane.</li><li><code class="code">pylint</code>: Alias of <code class="code">pylint2</code>.  Will change to <code class="code">pylint3</code> by end of 2019.</li><li><code class="code">pylint2</code>: Run Python code through <code class="code">pylint</code> using Python 2.</li><li><code class="code">pylint3</code>: Run Python code through <code class="code">pylint</code> using Python 3.</li><li><code class="code">rustfmt</code>: Run Rust code through <code class="code">rustfmt</code>.</li><li><code class="code">xmllint</code>: Run XML code through <code class="code">xmllint</code>.</li></ul><p>Note: Builtin hooks tend to match specific filenames (e.g. <code class="code">.json</code>).  If no files match in a specific commit, then the hook will be skipped for that commit.</p><pre class="code">[Builtin Hooks]
# Turn on cpplint checking.
cpplint = true
# Turn off gofmt checking.
gofmt = false
</pre><h2><a class="h" name="Builtin-Hooks-Options" href="#Builtin-Hooks-Options"><span></span></a><a class="h" name="builtin-hooks-options" href="#builtin-hooks-options"><span></span></a>[Builtin Hooks Options]</h2><p>Used to customize the behavior of specific <code class="code">[Builtin Hooks]</code>.  Any arguments set here will be passed directly to the linter in question.  This will completely override any existing default options, so be sure to include everything you need (especially <code class="code">${PREUPLOAD_FILES}</code> -- see below).</p><p>Quoting is handled naturally.  i.e. use <code class="code">&quot;a b c&quot;</code> to pass an argument with whitespace.</p><p>See <a href="#Placeholders">Placeholders</a> for variables you can expand automatically.</p><pre class="code">[Builtin Hooks Options]
# Pass more filter args to cpplint.
cpplint = --filter=-x ${PREUPLOAD_FILES}
</pre><h2><a class="h" name="Builtin-Hooks-Exclude-Paths" href="#Builtin-Hooks-Exclude-Paths"><span></span></a><a class="h" name="builtin-hooks-exclude-paths" href="#builtin-hooks-exclude-paths"><span></span></a>[Builtin Hooks Exclude Paths]</h2><div class="note">This section can only be added to the repo project-wide settings [GLOBAL-PREUPLOAD.cfg].</div><p>Used to explicitly exclude some projects when processing a hook. With this section, it is possible to define a hook that should apply to the majority of projects except a few.</p><p>An entry must completely match the project&#39;s <code class="code">REPO_PATH</code>. The paths can use the <a href="https://docs.python.org/library/fnmatch.html">shell-style wildcards</a> and quotes. For advanced cases, it is possible to use a <a href="https://docs.python.org/howto/regex.html">regular expression</a> by using the <code class="code">^</code> prefix.</p><pre class="code">[Builtin Hooks Exclude Paths]
# Run cpplint on all projects except ones under external/ and vendor/.
# The &quot;external&quot; and &quot;vendor&quot; projects, if they exist, will still run cpplint.
cpplint = external/* vendor/*

# Run rustfmt on all projects except ones under external/.  All projects under
# hardware/ will be excluded except for ones starting with hardware/google (due to
# the negative regex match).
rustfmt = external/ ^hardware/(!?google)
</pre><h2><a class="h" name="Tool-Paths" href="#Tool-Paths"><span></span></a><a class="h" name="tool-paths" href="#tool-paths"><span></span></a>[Tool Paths]</h2><p>Some builtin hooks need to call external executables to work correctly.  By default it will call those tools from the user&#39;s <code class="code">$PATH</code>, but the paths of those executables can be overridden through <code class="code">[Tool Paths]</code>.  This is helpful to provide consistent behavior for developers across different OS and Linux distros/versions.  The following tools are recognized:</p><ul><li><code class="code">aidl-format</code>: used for the <code class="code">aidl_format</code> builtin hook.</li><li><code class="code">android-test-mapping-format</code>: used for the <code class="code">android_test_mapping_format</code> builtin hook.</li><li><code class="code">bpfmt</code>: used for the <code class="code">bpfmt</code> builtin hook.</li><li><code class="code">clang-format</code>: used for the <code class="code">clang_format</code> builtin hook.</li><li><code class="code">cpplint</code>: used for the <code class="code">cpplint</code> builtin hook.</li><li><code class="code">git-clang-format</code>: used for the <code class="code">clang_format</code> builtin hook.</li><li><code class="code">gofmt</code>: used for the <code class="code">gofmt</code> builtin hook.</li><li><code class="code">google-java-format</code>: used for the <code class="code">google_java_format</code> builtin hook.</li><li><code class="code">google-java-format-diff</code>: used for the <code class="code">google_java_format</code> builtin hook.</li><li><code class="code">pylint</code>: used for the <code class="code">pylint</code> builtin hook.</li><li><code class="code">rustfmt</code>: used for the <code class="code">rustfmt</code> builtin hook.</li></ul><p>See <a href="#Placeholders">Placeholders</a> for variables you can expand automatically.</p><pre class="code">[Tool Paths]
# Pass absolute paths.
clang-format = /usr/bin/clang-format
# Or paths relative to the top of the git project.
clang-format = prebuilts/bin/clang-format
# Or paths relative to the repo root.
clang-format = ${REPO_ROOT}/prebuilts/clang/host/${BUILD_OS}/clang-stable/bin/clang-format
</pre><h1><a class="h" name="Hook-Developers" href="#Hook-Developers"><span></span></a><a class="h" name="hook-developers" href="#hook-developers"><span></span></a>Hook Developers</h1><p>These are notes for people updating the <code class="code">pre-upload.py</code> hook itself:</p><ul><li>Don&#39;t worry about namespace collisions.  The <code class="code">pre-upload.py</code> script is loaded and exec-ed in its own context.  The only entry-point that matters is <code class="code">main</code>.</li><li>New hooks can be added in <code class="code">rh/hooks.py</code>.  Be sure to keep the list up-to-date with the documentation in this file.</li></ul><h2><a class="h" name="Warnings" href="#Warnings"><span></span></a><a class="h" name="warnings" href="#warnings"><span></span></a>Warnings</h2><p>If the return code of a hook is 77, then it is assumed to be a warning.  The output will be printed to the terminal, but uploading will still be allowed without a bypass being required.</p><h1><a class="h" name="TODO_Limitations" href="#TODO_Limitations"><span></span></a><a class="h" name="todo_limitations" href="#todo_limitations"><span></span></a>TODO/Limitations</h1><ul><li><code class="code">pylint</code> should support per-directory pylintrc files.</li><li>Some checkers operate on the files as they exist in the filesystem.  This is not easy to fix because the linters require not just the modified file but the entire repo in order to perform full checks.  e.g. <code class="code">pylint</code> needs to know what other modules exist locally to verify their API.  We can support this case by doing a full checkout of the repo in a temp dir, but this can slow things down a lot.  Will need to consider a <code class="code">PREUPLOAD.cfg</code> knob.</li><li>We need to add <code class="code">pylint</code> tool to the AOSP manifest and use that local copy instead of relying on the version that is in $PATH.</li><li>Should make file extension filters configurable.  All hooks currently declare their own list of files like <code class="code">.cc</code> and <code class="code">.py</code> and <code class="code">.xml</code>.</li><li>Add more checkers.<ul><li><code class="code">clang-check</code>: Runs static analyzers against code.</li><li>License checking (like require AOSP header).</li><li>Whitespace checking (trailing/tab mixing/etc...).</li><li>Long line checking.</li><li>Commit message checks (correct format/BUG/TEST/SOB tags/etc...).</li><li>Markdown (gitiles) validator.</li><li>Spell checker.</li></ul></li></ul></div></div></div><!-- default customFooter --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><div class="Footer-links"></div></div></footer></body></html>